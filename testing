-- KS-Rivals Script Hub (with Notification System & Auto Match & Auto Load)
local UserInputService = game:GetService("UserInputService")
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local VirtualInputManager = game:GetService("VirtualInputManager")
local TweenService = game:GetService("TweenService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local LocalPlayer = Players.LocalPlayer
local Mouse = LocalPlayer:GetMouse()
local Camera = workspace.CurrentCamera

-- 텔레포트 시 스크립트 재실행을 위한 코드 저장
local SCRIPT_SOURCE = [=[
loadstring(game:HttpGet("YOUR_SCRIPT_URL_HERE"))()
]=]

-- 텔레포트 감지 및 스크립트 큐에 추가
if syn and syn.queue_on_teleport then
    syn.queue_on_teleport(SCRIPT_SOURCE)
elseif queue_on_teleport then
    queue_on_teleport(SCRIPT_SOURCE)
end

-- 설정 저장/불러오기
local function saveConfig()
    local config = {
        ESP_ENABLED = ESP_ENABLED,
        SILENT_AIM_ENABLED = SILENT_AIM_ENABLED,
        HP_BAR_ENABLED = HP_BAR_ENABLED,
        AIM_LOCK_ENABLED = AIM_LOCK_ENABLED,
        AUTO_AIM_ENABLED = AUTO_AIM_ENABLED,
        NOTIFICATION_ENABLED = NOTIFICATION_ENABLED,
        AUTO_MATCH_ENABLED = AUTO_MATCH_ENABLED,
        AUTO_AIM_MODE = AUTO_AIM_MODE,
        AUTO_MATCH_MODE = AUTO_MATCH_MODE,
        AIM_LOCK_KEY = tostring(AIM_LOCK_KEY)
    }
    writefile("KSRivals_Config.json", game:GetService("HttpService"):JSONEncode(config))
end

local function loadConfig()
    if isfile("KSRivals_Config.json") then
        local success, result = pcall(function()
            return game:GetService("HttpService"):JSONDecode(readfile("KSRivals_Config.json"))
        end)
        if success then return result end
    end
    return nil
end

-- 전역 상태 관리
local ESP_ENABLED = false
local SILENT_AIM_ENABLED = false
local HP_BAR_ENABLED = false
local AIM_LOCK_ENABLED = false
local AUTO_AIM_ENABLED = false
local NOTIFICATION_ENABLED = false
local AUTO_MATCH_ENABLED = false
local AUTO_AIM_MODE = "Silent"
local AUTO_MATCH_MODE = "1v1"
local AIM_LOCK_KEY = Enum.UserInputType.MouseButton2
local isAimLockHeld = false
local aimLockConnection
local lastClickTime = 0
local CLICK_INTERVAL = 0.12

-- 설정 불러오기
local savedConfig = loadConfig()
if savedConfig then
    ESP_ENABLED = savedConfig.ESP_ENABLED or false
    SILENT_AIM_ENABLED = savedConfig.SILENT_AIM_ENABLED or false
    HP_BAR_ENABLED = savedConfig.HP_BAR_ENABLED or false
    AIM_LOCK_ENABLED = savedConfig.AIM_LOCK_ENABLED or false
    AUTO_AIM_ENABLED = savedConfig.AUTO_AIM_ENABLED or false
    NOTIFICATION_ENABLED = savedConfig.NOTIFICATION_ENABLED or false
    AUTO_MATCH_ENABLED = savedConfig.AUTO_MATCH_ENABLED or false
    AUTO_AIM_MODE = savedConfig.AUTO_AIM_MODE or "Silent"
    AUTO_MATCH_MODE = savedConfig.AUTO_MATCH_MODE or "1v1"
end

-- UI 및 핸들러 설정
local KSRivals = Instance.new("ScreenGui")
KSRivals.Name = "KSRivals_Hub"
KSRivals.Parent = (game:GetService("CoreGui") or LocalPlayer.PlayerGui)
KSRivals.ResetOnSpawn = false

local MainFrame = Instance.new("Frame")
MainFrame.Name = "MainFrame"
MainFrame.Parent = KSRivals
MainFrame.BackgroundColor3 = Color3.fromRGB(8, 8, 8)
MainFrame.Position = UDim2.new(0.5, -240, 0.5, -160)
MainFrame.Size = UDim2.new(0, 480, 0, 320)
MainFrame.BorderSizePixel = 0

local MainStroke = Instance.new("UIStroke")
MainStroke.Color = Color3.fromRGB(255, 255, 255)
MainStroke.Thickness = 1
MainStroke.Parent = MainFrame

local TopBar = Instance.new("Frame")
TopBar.Size = UDim2.new(1, 0, 0, 25)
TopBar.BackgroundTransparency = 1
TopBar.Parent = MainFrame

local Title = Instance.new("TextLabel")
Title.Text = "KS-Rivals - Unnamed Enhancements"
Title.Font = Enum.Font.Code
Title.TextColor3 = Color3.fromRGB(255, 255, 255)
Title.TextSize = 13
Title.Size = UDim2.new(1, -60, 1, 0)
Title.Position = UDim2.new(0, 10, 0, 0)
Title.TextXAlignment = Enum.TextXAlignment.Left
Title.BackgroundTransparency = 1
Title.Parent = TopBar

local CloseBtn = Instance.new("TextButton")
CloseBtn.Size = UDim2.new(0, 25, 0, 25)
CloseBtn.Position = UDim2.new(1, -25, 0, 0)
CloseBtn.BackgroundTransparency = 1
CloseBtn.Text = "X"
CloseBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
CloseBtn.Font = Enum.Font.Code
CloseBtn.TextSize = 15
CloseBtn.Parent = TopBar

local TabContainer = Instance.new("Frame")
TabContainer.Size = UDim2.new(1, 0, 0, 30)
TabContainer.Position = UDim2.new(0, 0, 0, 25)
TabContainer.BackgroundTransparency = 1
TabContainer.Parent = MainFrame

local function CreateTabBtn(name, pos)
    local btn = Instance.new("TextButton")
    btn.Text = "  " .. name .. "  "
    btn.Font = Enum.Font.Code
    btn.TextColor3 = Color3.fromRGB(150, 150, 150)
    btn.TextSize = 14
    btn.BackgroundTransparency = 1
    btn.Size = UDim2.new(0, 80, 1, 0)
    btn.Position = pos
    btn.Parent = TabContainer
    return btn
end

local AimTab = CreateTabBtn("main", UDim2.new(0, 0, 0, 0))
local VisualTab = CreateTabBtn("visuals", UDim2.new(0, 85, 0, 0))

local Content = Instance.new("Frame")
Content.Size = UDim2.new(1, -20, 1, -65)
Content.Position = UDim2.new(0, 10, 0, 55)
Content.BackgroundTransparency = 1
Content.Parent = MainFrame

local AimPage = Instance.new("Frame")
AimPage.Size = UDim2.new(1, 0, 1, 0)
AimPage.BackgroundTransparency = 1
AimPage.Visible = true
AimPage.Parent = Content

local VisualPage = Instance.new("Frame")
VisualPage.Size = UDim2.new(1, 0, 1, 0)
VisualPage.BackgroundTransparency = 1
VisualPage.Visible = false
VisualPage.Parent = Content

local UIHandlers = {}

local function ShowTab(tabName)
    if tabName == "Aim" then
        AimPage.Visible = true VisualPage.Visible = false
        AimTab.TextColor3 = Color3.fromRGB(255, 255, 255)
        VisualTab.TextColor3 = Color3.fromRGB(130, 130, 130)
    else
        AimPage.Visible = false VisualPage.Visible = true
        AimTab.TextColor3 = Color3.fromRGB(130, 130, 130)
        VisualTab.TextColor3 = Color3.fromRGB(255, 255, 255)
    end
end
AimTab.MouseButton1Click:Connect(function() ShowTab("Aim") end)
VisualTab.MouseButton1Click:Connect(function() ShowTab("Visual") end)

-- 공용 컴포넌트
local function CreateToggle(name, parent, callback, configType)
    local container = Instance.new("Frame")
    container.Size = UDim2.new(1, 0, 0, 24)
    container.BackgroundTransparency = 1
    container.Parent = parent

    local box = Instance.new("TextButton")
    box.Size = UDim2.new(0, 14, 0, 14)
    box.Position = UDim2.new(0, 5, 0.5, -7)
    box.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
    box.Text = ""
    box.BorderSizePixel = 0
    box.Parent = container

    local boxStroke = Instance.new("UIStroke")
    boxStroke.Color = Color3.fromRGB(255, 255, 255)
    boxStroke.Thickness = 1
    boxStroke.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
    boxStroke.Parent = box

    local checkInner = Instance.new("Frame")
    checkInner.Size = UDim2.new(1, -4, 1, -4)
    checkInner.Position = UDim2.new(0, 2, 0, 2)
    checkInner.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
    checkInner.Visible = false
    checkInner.BorderSizePixel = 0
    checkInner.Parent = box

    local label = Instance.new("TextButton")
    label.Size = UDim2.new(1, -100, 1, 0)
    label.Position = UDim2.new(0, 30, 0, 0)
    label.BackgroundTransparency = 1
    label.Text = name
    label.Font = Enum.Font.Code
    label.TextColor3 = Color3.fromRGB(255, 255, 255)
    label.TextSize = 13
    label.TextXAlignment = Enum.TextXAlignment.Left
    label.Parent = container

    local enabled = false
    local function setEnabled(val)
        enabled = val
        checkInner.Visible = val
        callback(val)
        saveConfig()
    end
    box.MouseButton1Click:Connect(function() setEnabled(not enabled) end)
    label.MouseButton1Click:Connect(function() setEnabled(not enabled) end)

    if configType then
        local configBtn = Instance.new("TextButton")
        configBtn.Size = UDim2.new(0, 60, 0, 18)
        configBtn.Position = UDim2.new(1, -65, 0.5, -9)
        configBtn.BackgroundColor3 = Color3.fromRGB(15, 15, 15)
        configBtn.Font = Enum.Font.Code
        configBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
        configBtn.TextSize = 11
        configBtn.BorderSizePixel = 0
        configBtn.Parent = container

        local configStroke = Instance.new("UIStroke")
        configStroke.Color = Color3.fromRGB(255, 255, 255)
        configStroke.Thickness = 1
        configStroke.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
        configStroke.Parent = configBtn

        if configType == "Keybind" then
            configBtn.Text = "[MB2]"
            configBtn.MouseButton1Click:Connect(function()
                configBtn.Text = "..."
                local inputConn
                inputConn = UserInputService.InputBegan:Connect(function(input)
                    local newBind = input.UserInputType == Enum.UserInputType.Keyboard and input.KeyCode or input.UserInputType
                    if newBind ~= Enum.UserInputType.MouseMovement then
                        AIM_LOCK_KEY = newBind
                        configBtn.Text = "[" .. (input.KeyCode.Name ~= "Unknown" and input.KeyCode.Name or input.UserInputType.Name) .. "]"
                        saveConfig()
                        inputConn:Disconnect()
                    end
                end)
            end)
        elseif configType == "AimMode" then
            configBtn.Text = AUTO_AIM_MODE
            configBtn.MouseButton1Click:Connect(function()
                AUTO_AIM_MODE = (AUTO_AIM_MODE == "Silent") and "Aim" or "Silent"
                configBtn.Text = AUTO_AIM_MODE
                saveConfig()
                if AUTO_AIM_ENABLED then
                    if AUTO_AIM_MODE == "Silent" then UIHandlers.UpdateSilentAim(true) UIHandlers.UpdateAimLock(false)
                    else UIHandlers.UpdateSilentAim(false) UIHandlers.UpdateAimLock(true) end
                end
            end)
        elseif configType == "MatchMode" then
            configBtn.Text = AUTO_MATCH_MODE
            local modes = {"1v1", "2v2", "3v3", "4v4", "5v5"}
            configBtn.MouseButton1Click:Connect(function()
                local currentIndex = 1
                for i, mode in ipairs(modes) do
                    if mode == AUTO_MATCH_MODE then
                        currentIndex = i
                        break
                    end
                end
                local nextIndex = (currentIndex % #modes) + 1
                AUTO_MATCH_MODE = modes[nextIndex]
                configBtn.Text = AUTO_MATCH_MODE
                saveConfig()
            end)
        end
    end
    return setEnabled
end

local function CreateButton(name, parent, callback)
    local btn = Instance.new("TextButton")
    btn.Size = UDim2.new(0, 140, 0, 26)
    btn.BackgroundColor3 = Color3.fromRGB(15, 15, 15)
    btn.Text = name
    btn.Font = Enum.Font.Code
    btn.TextColor3 = Color3.fromRGB(255, 255, 255)
    btn.TextSize = 13
    btn.BorderSizePixel = 0
    btn.Parent = parent
    local s = Instance.new("UIStroke")
    s.Color = Color3.fromRGB(255, 255, 255)
    s.Thickness = 1
    s.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
    s.Parent = btn
    btn.MouseButton1Click:Connect(callback)
end

local AimList = Instance.new("UIListLayout")
AimList.Padding = UDim.new(0, 4)
AimList.Parent = AimPage

local VisualList = Instance.new("UIListLayout")
VisualList.Padding = UDim.new(0, 4)
VisualList.Parent = VisualPage

-----------------------------------------------------------
-- [Auto Match System]
-----------------------------------------------------------
local function joinMatchmaking()
    if not AUTO_MATCH_ENABLED then return end
    
    task.wait(1) -- 플레이스 로드 대기
    
    local success, err = pcall(function()
        local args = { AUTO_MATCH_MODE }
        ReplicatedStorage:WaitForChild("Remotes"):WaitForChild("Matchmaking"):WaitForChild("JoinQueue"):InvokeServer(unpack(args))
    end)
    
    if not success then
        warn("Auto Match 실패:", err)
    end
end

-- 플레이스 변경 감지
game:GetService("TeleportService").TeleportInitFailed:Connect(function(player, result, message)
    warn("Teleport failed:", message)
end)

-- 텔레포트 감지 (추가 보안)
LocalPlayer.OnTeleport:Connect(function(state)
    if state == Enum.TeleportState.Started then
        -- 텔레포트 시작 시 설정 저장
        saveConfig()
        
        -- 스크립트 재실행 큐에 추가 (여러 방법 시도)
        local scriptCode = [[
-- Auto-reload KS-Rivals Hub
task.wait(2)
if not getgenv().KSRivalsAutoReloaded then
    getgenv().KSRivalsAutoReloaded = true
    ]] .. SCRIPT_SOURCE .. [[
end
        ]]
        
        -- 다양한 executor 지원
        if syn and syn.queue_on_teleport then
            syn.queue_on_teleport(scriptCode)
        elseif queue_on_teleport then
            queue_on_teleport(scriptCode)
        elseif queueonteleport then
            queueonteleport(scriptCode)
        end
        
    elseif state == Enum.TeleportState.InProgress then
        -- 텔레포트 진행 중
        print("Teleporting... Hub will reload automatically")
    end
end)

-- 스크립트 로드 시 자동 매치 실행
if AUTO_MATCH_ENABLED then
    joinMatchmaking()
end

-----------------------------------------------------------
-- [Notification System]
-----------------------------------------------------------
local NotificationGui = Instance.new("ScreenGui")
NotificationGui.Name = "NotificationSystem"
NotificationGui.ResetOnSpawn = false
NotificationGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
NotificationGui.Parent = LocalPlayer.PlayerGui

local NotifContainer = Instance.new("Frame")
NotifContainer.Name = "Container"
NotifContainer.Size = UDim2.new(0, 200, 0, 300)
NotifContainer.Position = UDim2.new(0, 10, 0, 10)
NotifContainer.BackgroundTransparency = 1
NotifContainer.Parent = NotificationGui

local NotifLayout = Instance.new("UIListLayout")
NotifLayout.SortOrder = Enum.SortOrder.LayoutOrder
NotifLayout.Padding = UDim.new(0, 3)
NotifLayout.Parent = NotifContainer

local notifications = {}
local maxNotifications = 12
local displayTime = 1.5

local function createNotification(text, color)
    if not NOTIFICATION_ENABLED then return end
    
    if #notifications >= maxNotifications then
        local oldest = table.remove(notifications, 1)
        if oldest then oldest:Destroy() end
    end
    
    local notif = Instance.new("Frame")
    notif.Size = UDim2.new(1, 0, 0, 22)
    notif.BackgroundColor3 = Color3.new(0, 0, 0)
    notif.BackgroundTransparency = 0.3
    notif.BorderSizePixel = 0
    notif.ClipsDescendants = true
    notif.LayoutOrder = #notifications + 1
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 4)
    corner.Parent = notif
    
    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(1, -6, 1, 0)
    label.Position = UDim2.new(0, 3, 0, 0)
    label.BackgroundTransparency = 1
    label.Text = text
    label.TextColor3 = Color3.new(1, 1, 1)
    label.TextSize = 12
    label.Font = Enum.Font.GothamBold
    label.TextXAlignment = Enum.TextXAlignment.Left
    label.TextScaled = false
    label.TextWrapped = false
    label.TextStrokeTransparency = 0.5
    label.Parent = notif
    
    notif.Size = UDim2.new(0, 0, 0, 22)
    notif.Parent = NotifContainer
    
    local tweenInfo = TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)
    local tween = TweenService:Create(notif, tweenInfo, {Size = UDim2.new(1, 0, 0, 22)})
    tween:Play()
    
    table.insert(notifications, notif)
    
    task.delay(displayTime, function()
        if notif and notif.Parent then
            local fadeInfo = TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.In)
            local fadeTween = TweenService:Create(notif, fadeInfo, {Size = UDim2.new(0, 0, 0, 22)})
            fadeTween:Play()
            fadeTween.Completed:Connect(function()
                notif:Destroy()
                for i, n in ipairs(notifications) do
                    if n == notif then
                        table.remove(notifications, i)
                        break
                    end
                end
            end)
        end
    end)
end

local trackedPlayers = {}

local function setupPlayerTracking(otherPlayer)
    if otherPlayer == LocalPlayer then return end
    
    local function onCharacterAdded(character)
        local humanoid = character:WaitForChild("Humanoid", 5)
        if not humanoid then return end
        
        trackedPlayers[otherPlayer.UserId] = {
            lastHealth = humanoid.Health,
            humanoid = humanoid
        }
        
        humanoid.HealthChanged:Connect(function(health)
            local data = trackedPlayers[otherPlayer.UserId]
            if not data then return end
            
            local diff = health - data.lastHealth
            
            if diff < 0 then
                createNotification(
                    string.format("Hit %s -%d", otherPlayer.Name, math.floor(-diff)),
                    Color3.fromRGB(220, 50, 50)
                )
            elseif diff > 0 then
                createNotification(
                    string.format("Healing %s +%d", otherPlayer.Name, math.floor(diff)),
                    Color3.fromRGB(50, 200, 100)
                )
            end
            
            data.lastHealth = health
        end)
        
        humanoid.Died:Connect(function()
            createNotification(
                string.format("Killed %s", otherPlayer.Name),
                Color3.fromRGB(180, 50, 180)
            )
        end)
    end
    
    if otherPlayer.Character then
        onCharacterAdded(otherPlayer.Character)
    end
    otherPlayer.CharacterAdded:Connect(onCharacterAdded)
end

local function setupSelfTracking()
    local function onCharacterAdded(character)
        local humanoid = character:WaitForChild("Humanoid", 5)
        if not humanoid then return end
        
        local lastHealth = humanoid.Health
        
        humanoid.HealthChanged:Connect(function(health)
            local diff = health - lastHealth
            
            if diff < 0 then
                createNotification(
                    string.format("Damage -%d", math.floor(-diff)),
                    Color3.fromRGB(255, 100, 100)
                )
            end
            
            lastHealth = health
        end)
    end
    
    if LocalPlayer.Character then
        onCharacterAdded(LocalPlayer.Character)
    end
    LocalPlayer.CharacterAdded:Connect(onCharacterAdded)
end

for _, otherPlayer in ipairs(Players:GetPlayers()) do
    setupPlayerTracking(otherPlayer)
end

Players.PlayerAdded:Connect(setupPlayerTracking)
setupSelfTracking()

Players.PlayerRemoving:Connect(function(otherPlayer)
    trackedPlayers[otherPlayer.UserId] = nil
end)

-----------------------------------------------------------
-- [Aim] Logic
-----------------------------------------------------------
local function getClosestPlayer()
    local closest, shortestDist = nil, math.huge
    for _, p in pairs(Players:GetPlayers()) do
        if p ~= LocalPlayer and p.Character and p.Character:FindFirstChild("Head") then
            local head = p.Character.Head
            local _, onScreen = Camera:WorldToScreenPoint(head.Position)
            if onScreen then
                local dist = (LocalPlayer.Character.HumanoidRootPart.Position - head.Position).Magnitude
                if dist < shortestDist then shortestDist = dist closest = p end
            end
        end
    end
    return closest
end

local function updateAimLock()
    if not isAimLockHeld or not AIM_LOCK_ENABLED then return end
    local t = getClosestPlayer()
    if t and t.Character:FindFirstChild("Head") then
        local pos = Camera:WorldToScreenPoint(t.Character.Head.Position)
        mousemoverel(math.floor(pos.X - Mouse.X + 0.5), math.floor(pos.Y - Mouse.Y + 0.5))
    end
end

UserInputService.InputBegan:Connect(function(i, gpe)
    if not gpe and AIM_LOCK_ENABLED and (i.KeyCode == AIM_LOCK_KEY or i.UserInputType == AIM_LOCK_KEY) then
        isAimLockHeld = true
        if aimLockConnection then aimLockConnection:Disconnect() end
        aimLockConnection = RunService.RenderStepped:Connect(updateAimLock)
    elseif not gpe and SILENT_AIM_ENABLED and i.UserInputType == Enum.UserInputType.MouseButton1 then
        local t = getClosestPlayer()
        if t then Camera.CFrame = CFrame.new(Camera.CFrame.Position, t.Character.Head.Position) end
    end
end)
UserInputService.InputEnded:Connect(function(i)
    if i.KeyCode == AIM_LOCK_KEY or i.UserInputType == AIM_LOCK_KEY then
        isAimLockHeld = false
        if aimLockConnection then aimLockConnection:Disconnect() aimLockConnection = nil end
    end
end)

local function isVisible(p)
    if not p.Character or not p.Character:FindFirstChild("HumanoidRootPart") then return false end
    local hrp = p.Character.HumanoidRootPart
    local rayParams = RaycastParams.new()
    rayParams.FilterDescendantsInstances = {LocalPlayer.Character, p.Character}
    rayParams.FilterType = Enum.RaycastFilterType.Exclude
    local res = workspace:Raycast(Camera.CFrame.Position, hrp.Position - Camera.CFrame.Position, rayParams)
    return not res
end

RunService.RenderStepped:Connect(function()
    if not AUTO_AIM_ENABLED or MainFrame.Visible then return end
    
    local targetFound = false
    if AUTO_AIM_MODE == "Silent" then
        for _, p in ipairs(Players:GetPlayers()) do
            if p ~= LocalPlayer and isVisible(p) then targetFound = true break end
        end
    elseif AUTO_AIM_MODE == "Aim" then
        local target = Mouse.Target
        if target and target.Parent then
            local char = target.Parent:IsA("Model") and target.Parent or target.Parent.Parent
            local player = Players:GetPlayerFromCharacter(char)
            if player and player ~= LocalPlayer and player.Character:FindFirstChild("Humanoid") and player.Character.Humanoid.Health > 0 then
                targetFound = true
            end
        end
    end

    if targetFound then
        local cur = tick()
        if cur - lastClickTime >= CLICK_INTERVAL then
            lastClickTime = cur
            VirtualInputManager:SendMouseButtonEvent(Mouse.X, Mouse.Y, 0, true, game, 0)
            task.wait(0.01)
            VirtualInputManager:SendMouseButtonEvent(Mouse.X, Mouse.Y, 0, false, game, 0)
        end
    end
end)

UIHandlers.UpdateSilentAim = CreateToggle("enabled (silent aim)", AimPage, function(v) SILENT_AIM_ENABLED = v end)
UIHandlers.UpdateAimLock = CreateToggle("Aim Lock", AimPage, function(v) AIM_LOCK_ENABLED = v end, "Keybind")
UIHandlers.UpdateAutoAim = CreateToggle("Auto Aim", AimPage, function(v) 
    AUTO_AIM_ENABLED = v 
    if v then
        if AUTO_AIM_MODE == "Silent" then UIHandlers.UpdateSilentAim(true) UIHandlers.UpdateAimLock(false)
        else UIHandlers.UpdateSilentAim(false) UIHandlers.UpdateAimLock(true) end
    end
end, "AimMode")

UIHandlers.UpdateAutoMatch = CreateToggle("Auto Match", AimPage, function(v) 
    AUTO_MATCH_ENABLED = v
    if v then
        joinMatchmaking()
    end
end, "MatchMode")

-----------------------------------------------------------
-- [Visual] Logic
-----------------------------------------------------------
local function createESP(player)
    if player == LocalPlayer then return end
    local function onChar(char)
        local root = char:WaitForChild("HumanoidRootPart", 5)
        local hum = char:WaitForChild("Humanoid", 5)
        if not root or not hum then return end
        
        local bGui = Instance.new("BillboardGui", root)
        bGui.Name = "ESP_Gui" bGui.Size = UDim2.new(4,0,5.5,0) bGui.AlwaysOnTop = true bGui.Enabled = ESP_ENABLED
        local function line(s, p)
            local f = Instance.new("Frame", bGui) f.BackgroundColor3 = Color3.new(1,1,1) f.BorderSizePixel = 0 f.Size = s f.Position = p return f
        end
        local l = {t = line(UDim2.new(1,0,0,1), UDim2.new(0,0,0,0)), b = line(UDim2.new(1,0,0,1), UDim2.new(0,0,1,-1)), ls = line(UDim2.new(0,1,1,0), UDim2.new(0,0,0,0)), rs = line(UDim2.new(0,1,1,0), UDim2.new(1,-1,0,0))}

        local hGui = Instance.new("BillboardGui", root)
        hGui.Name = "HealthESP_Gui" hGui.Size = UDim2.new(1,0,5.5,0) hGui.StudsOffset = Vector3.new(2.5,0,0) hGui.AlwaysOnTop = true hGui.Enabled = HP_BAR_ENABLED
        local barBg = Instance.new("Frame", hGui) barBg.Size = UDim2.new(0.2,0,1,0) barBg.BackgroundColor3 = Color3.fromRGB(50,50,50) barBg.BorderSizePixel = 0
        local hFill = Instance.new("Frame", barBg) hFill.Size = UDim2.new(1,0,1,0) hFill.Position = UDim2.new(0,0,1,0) hFill.AnchorPoint = Vector2.new(0,1) hFill.BackgroundColor3 = Color3.fromRGB(0,255,0) hFill.BorderSizePixel = 0
        local hText = Instance.new("TextLabel", barBg) hText.Size = UDim2.new(3,0,0.2,0) hText.Position = UDim2.new(1.2,0,0,0) hText.BackgroundTransparency = 1 hText.TextColor3 = Color3.new(1,1,1) hText.TextScaled = true hText.Font = Enum.Font.SourceSansBold

        local function update()
            local p = math.clamp(hum.Health/hum.MaxHealth, 0, 1)
            hFill.Size = UDim2.new(1,0,p,0) hFill.BackgroundColor3 = Color3.fromHSV(p*0.3, 1, 1)
            hText.Text = math.floor(hum.Health).."/"..math.floor(hum.MaxHealth)
        end
        hum.HealthChanged:Connect(function() update() for _,v in pairs(l) do v.BackgroundColor3 = Color3.new(1,0,0) end task.wait(0.2) for _,v in pairs(l) do v.BackgroundColor3 = Color3.new(1,1,1) end end)
        update()
    end
    player.CharacterAdded:Connect(onChar) if player.Character then onChar(player.Character) end
end
for _, p in pairs(Players:GetPlayers()) do createESP(p) end
Players.PlayerAdded:Connect(createESP)

CreateToggle("enabled (esp)", VisualPage, function(v) ESP_ENABLED = v for _,p in pairs(Players:GetPlayers()) do local r = p.Character and p.Character:FindFirstChild("HumanoidRootPart") if r then local g = r:FindFirstChild("ESP_Gui") if g then g.Enabled = v end end end end)
CreateToggle("HP bar", VisualPage, function(v) HP_BAR_ENABLED = v for _,p in pairs(Players:GetPlayers()) do local r = p.Character and p.Character:FindFirstChild("HumanoidRootPart") if r then local g = r:FindFirstChild("HealthESP_Gui") if g then g.Enabled = v end end end end)
CreateToggle("Notification", VisualPage, function(v) NOTIFICATION_ENABLED = v end)

CreateButton("mesh wrapping", VisualPage, function()
    local VM = workspace:FindFirstChild("ViewModels")
    local FP = VM and VM:FindFirstChild("FirstPerson")
    if not FP then return end
    local function setup(m)
        if not m:IsA("MeshPart") then return end
        m.Material, m.Color = Enum.Material.ForceField, Color3.new(0,0,0)
        for _, f in ipairs({Enum.NormalId.Top, Enum.NormalId.Bottom, Enum.NormalId.Left, Enum.NormalId.Right, Enum.NormalId.Front, Enum.NormalId.Back}) do
            local t = m:FindFirstChild("FixedTexture_"..f.Name) or Instance.new("Texture", m)
            t.Name, t.Texture, t.Face, t.Color3, t.StudsPerTileU, t.StudsPerTileV = "FixedTexture_"..f.Name, "rbxassetid://135989547473439", f, Color3.new(0,0,0), 0.1, 0.1
        end
        m.Changed:Connect(function() m.Material, m.Color = Enum.Material.ForceField, Color3.new(0,0,0) end)
    end
    for _, o in ipairs(FP:GetDescendants()) do setup(o) end
    FP.DescendantAdded:Connect(setup)
end)

-- 저장된 설정 적용
if savedConfig then
    task.wait(0.1)
    if savedConfig.ESP_ENABLED then
        for _,p in pairs(Players:GetPlayers()) do 
            local r = p.Character and p.Character:FindFirstChild("HumanoidRootPart") 
            if r then 
                local g = r:FindFirstChild("ESP_Gui") 
                if g then g.Enabled = true end 
            end 
        end
    end
    if savedConfig.HP_BAR_ENABLED then
        for _,p in pairs(Players:GetPlayers()) do 
            local r = p.Character and p.Character:FindFirstChild("HumanoidRootPart") 
            if r then 
                local g = r:FindFirstChild("HealthESP_Gui") 
                if g then g.Enabled = true end 
            end 
        end
    end
    
    -- UI 토글 상태 적용
    if UIHandlers.UpdateSilentAim then UIHandlers.UpdateSilentAim(savedConfig.SILENT_AIM_ENABLED) end
    if UIHandlers.UpdateAimLock then UIHandlers.UpdateAimLock(savedConfig.AIM_LOCK_ENABLED) end
    if UIHandlers.UpdateAutoAim then UIHandlers.UpdateAutoAim(savedConfig.AUTO_AIM_ENABLED) end
    if UIHandlers.UpdateAutoMatch then UIHandlers.UpdateAutoMatch(savedConfig.AUTO_MATCH_ENABLED) end
end

-- UI 관리
local dragging, dragStart, startPos
MainFrame.InputBegan:Connect(function(input) if input.UserInputType == Enum.UserInputType.MouseButton1 then dragging = true dragStart = input.Position startPos = MainFrame.Position end end)
UserInputService.InputChanged:Connect(function(input) if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then local delta = input.Position - dragStart MainFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y) end end)
UserInputService.InputEnded:Connect(function(input) if input.UserInputType == Enum.UserInputType.MouseButton1 then dragging = false end end)
local function ToggleUI() MainFrame.Visible = not MainFrame.Visible end
CloseBtn.MouseButton1Click:Connect(ToggleUI)
UserInputService.InputBegan:Connect(function(input, gpe) if not gpe and input.KeyCode == Enum.KeyCode.K then ToggleUI() end end)
ShowTab("Aim")

-- 스크립트가 재실행될 때를 대비한 처리
if getgenv().KSRivalsLoaded then
    -- 기존 UI 제거
    if game:GetService("CoreGui"):FindFirstChild("KSRivals_Hub") then
        game:GetService("CoreGui"):FindFirstChild("KSRivals_Hub"):Destroy()
    end
    if LocalPlayer.PlayerGui:FindFirstChild("KSRivals_Hub") then
        LocalPlayer.PlayerGui:FindFirstChild("KSRivals_Hub"):Destroy()
    end
    if LocalPlayer.PlayerGui:FindFirstChild("NotificationSystem") then
        LocalPlayer.PlayerGui:FindFirstChild("NotificationSystem"):Destroy()
    end
    warn("KS-Rivals Hub reloading...")
    task.wait(0.5)
end

getgenv().KSRivalsLoaded = true
getgenv().KSRivalsAutoReloaded = false
print("━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━")
print("KS-Rivals Hub loaded successfully!")
print("Press K to toggle UI")
print("All settings are saved automatically")
if AUTO_MATCH_ENABLED then
    print("Auto Match: ENABLED (" .. AUTO_MATCH_MODE .. ")")
end
print("━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━")
